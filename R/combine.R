combine_profiles <- function(prof_path, out_path) {
  ds_rprof <- profile::read_rprof(out_path, version = "1.0")
  print(out_path)

  proto_path <- tempfile("jointprof", fileext = ".pb.gz")
  system2(
    find_pprof(),
    c("-proto", "-output", shQuote(proto_path), shQuote(prof_path))
  )
  ds_pprof <- profile::read_pprof(proto_path, version = "1.0")

  stopifnot(sum(ds_pprof$samples$value) == sum(ds_rprof$samples$value))
  stopifnot(ds_rprof$samples$value == 1)

  ds_pprof <- shift_ids(ds_pprof, ds_rprof)
  ds_rprof <- expand_samples(ds_rprof)
  ds_pprof <- expand_samples(ds_pprof)

  ds_combined <- combine_ds(ds_rprof, ds_pprof)
  ds_merged <- patch_combined_ds(ds_combined)
  ds_pruned <- prune_ds(ds_merged)
  ds_pruned
}

shift_ids <- function(ds, ds_base) {
  d_location_id <- max(ds_base$locations$location_id)
  d_function_id <- max(ds_base$functions$function_id)

  ds$samples$locations <- map(ds$samples$locations, function(x) {
    x$location_id <- x$location_id + d_location_id
    x
  })
  ds$locations$location_id <- ds$locations$location_id + d_location_id

  ds$locations$function_id <- ds$locations$function_id + d_function_id
  ds$functions$function_id <- ds$functions$function_id + d_function_id

  profile::validate_profile(ds)
  ds
}

expand_samples <- function(ds) {
  new_samples <- tibble::tibble(
    value = 1L,
    locations = rep(ds$samples$locations, ds$samples$value)
  )

  ds$samples <- new_samples
  profile::validate_profile(ds)
  ds
}

combine_ds <- function(ds_rprof, ds_pprof) {
  ds_rprof$samples$.pprof_locations <- ds_pprof$samples$locations
  ds_rprof$locations <- tibble::as_tibble(rbind(
    strip_dots(ds_rprof$locations), strip_dots(ds_pprof$locations)
  ))
  ds_rprof$functions <- tibble::as_tibble(rbind(
    strip_dots(ds_rprof$functions), strip_dots(ds_pprof$functions)
  ))
  profile::validate_profile(ds_rprof)
  ds_rprof
}

strip_dots <- function(x) {
  x[grep("^[.]", names(x))] <- NULL
  x
}

patch_combined_ds <- function(ds_combined) {
  ds_combined$samples$.rprof_locations <- ds_combined$samples$locations

  . <- merge(ds_combined$locations, ds_combined$functions, by = "function_id", all.x = TRUE)
  . <- tibble::as_tibble(.)
  locations_flat <- .

  ds_combined$samples$locations <- map2(
    ds_combined$samples$.rprof_locations,
    ds_combined$samples$.pprof_locations,
    patch_locations,
    list(locations_flat)
  )
  ds_combined
}

patch_locations <- function(rprof_locations, pprof_locations, locations_flat) {
  . <- rprof_locations
  . <- tibble::rowid_to_column(., "rprof_id")
  . <- merge(., locations_flat, by = "location_id", sort = FALSE)
  . <- .[order(.$rprof_id), ]
  . <- tibble::as_tibble(., rownames = NULL)
  rprof_locations_full <- .
  stopifnot(rprof_locations$location_id == rprof_locations_full$location_id)
  
  . <- pprof_locations
  . <- tibble::rowid_to_column(., "pprof_id")
  . <- merge(., locations_flat, by = "location_id", sort = FALSE)
  . <- .[order(.$pprof_id), ]
  . <- tibble::as_tibble(., rownames = NULL)
  pprof_locations_full <- .
  stopifnot(pprof_locations$location_id == pprof_locations_full$location_id)
  
  exec_names <- c("R_execClosure", "do_eval", "do_recall", "do_dotcall")
  #exec_names <- c("R_execClosure", "do_eval", "do_recall", "R_DispatchOrEvalSP", "do_dotcall")
  exec_idx <- which(pprof_locations_full$system_name %in% exec_names)

  result <- NULL
  past_loc_idx <- nrow(pprof_locations_full)

  n <- min(length(exec_idx), nrow(rprof_locations_full))
  for (i in seq(n)) {
    loc_idx <- exec_idx[[length(exec_idx) + 1 - i]]
    result <- c(
      rprof_locations_full$location_id[[nrow(rprof_locations_full) + 1 - i]],
      pprof_locations_full$location_id[rlang::seq2(loc_idx, past_loc_idx)],
      result)
    past_loc_idx <- loc_idx - 1
  }

  result <- c(
    rprof_locations_full$location_id[rlang::seq2(1, nrow(rprof_locations_full) - n)],
    pprof_locations_full$location_id[rlang::seq2(1, past_loc_idx)],
    result)

  return(tibble::tibble(location_id = result))
}

prune_ds <- function(ds) {
  # FIXME: prune unused locations and functions
  ds
}
